<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票投资组合仪表盘 (Pro版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js 用于数据可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Google Fonts 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 全局与背景样式 --- */
        body {
            font-family: 'Inter', sans-serif;
            background: #0c0a18; /* 深邃的午夜蓝背景 */
            color: #e0e0e0; /* 柔和的白色文字 */
            overflow-x: hidden;
            position: relative;
        }
        /* 动态背景光晕效果 */
        body::before {
            content: '';
            position: fixed;
            top: 20%;
            left: 10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.4) 0%, rgba(79, 70, 229, 0) 70%);
            animation: pulse-glow-1 15s infinite alternate;
            z-index: -1;
        }
        body::after {
            content: '';
            position: fixed;
            bottom: 10%;
            right: 5%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(132, 59, 246, 0.3) 0%, rgba(132, 59, 246, 0) 70%);
            animation: pulse-glow-2 20s infinite alternate;
            z-index: -1;
        }
        @keyframes pulse-glow-1 {
            from { transform: translate(-20%, -20%) scale(0.8); }
            to { transform: translate(20%, 20%) scale(1.2); }
        }
        @keyframes pulse-glow-2 {
            from { transform: translate(10%, 10%) scale(1.2); }
            to { transform: translate(-10%, -10%) scale(0.8); }
        }

        /* --- “玻璃拟态”卡片样式 --- */
        .card {
            background-color: rgba(30, 27, 51, 0.5); /* 半透明背景 */
            backdrop-filter: blur(12px); /* 关键的模糊效果 */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* --- 输入框与其他元素样式 --- */
        .input-field {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            color: #fff;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
        .btn-primary {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }
        .btn-primary:disabled {
            background: #374151;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .positive-value { color: #4ade80; } /* 更亮的绿色 */
        .negative-value { color: #f87171; } /* 更柔和的红色 */
        .loader {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
        
        <header class="mb-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-white tracking-tight">投资组合仪表盘 Pro</h1>
            <p class="text-gray-400 mt-2 text-lg">实时洞察您的资产脉搏</p>
            <button id="refreshBtn" class="btn-primary mt-6 text-lg">
                <span id="btn-text">刷新实时数据</span>
                <span id="btn-loader" class="loader hidden"></span>
            </button>
        </header>

        <main id="dashboard-content">
            <!-- 摘要信息卡片 -->
            <div id="summary" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- 卡片内容将由JS动态生成 -->
            </div>

            <!-- 可视化图表 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="card lg:col-span-1">
                    <h3 class="text-xl font-semibold text-white mb-4">持仓分布</h3>
                    <div class="relative h-64 md:h-80"><canvas id="portfolioPieChart"></canvas></div>
                </div>
                 <div class="card lg:col-span-1">
                    <h3 class="text-xl font-semibold text-white mb-4">投资策略分布</h3>
                    <div class="relative h-64 md:h-80"><canvas id="categoryPieChart"></canvas></div>
                </div>
                <div class="card lg:col-span-1">
                    <h3 class="text-xl font-semibold text-white mb-4">个股总盈亏</h3>
                     <div class="relative h-64 md:h-80"><canvas id="profitLossBarChart"></canvas></div>
                </div>
            </div>

            <!-- 持仓详情表格 -->
            <div class="card overflow-x-auto">
                <h3 class="text-xl font-semibold text-white mb-4">持仓详情</h3>
                <table class="w-full text-left">
                    <thead class="border-b border-white/10 text-gray-400">
                        <tr>
                            <th class="p-3">股票代码</th>
                            <th class="p-3 text-right">数量</th>
                            <th class="p-3 text-right">成本价 ($)</th>
                            <th class="p-3 text-right">当前价 ($)</th>
                            <th class="p-3 text-right">市值 ($)</th>
                            <th class="p-3 text-right">单日盈亏 ($)</th>
                            <th class="p-3 text-right">总盈亏 ($)</th>
                            <th class="p-3 text-right">总盈亏 (%)</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-table-body"></tbody>
                </table>
            </div>
        </main>
        
        <footer class="text-center text-gray-500 mt-8 text-sm">
            <p id="update-status" class="mb-2"></p>
            <p>免责声明：数据由 Alpha Vantage 提供，可能存在延迟，不构成投资建议。</p>
        </footer>
    </div>

<script>
// --- 1. 初始数据 & 状态管理 ---
const initialPortfolio = [
    { ticker: 'NVDA', shares: 150, cost: 170.29, categories: ['AI硬件'] },
    { ticker: 'GOOGL', shares: 100, cost: 249.53, categories: ['AI软件'] },
    { ticker: 'TSLA', shares: 50, cost: 425.86, categories: ['机器人'] },
    { ticker: 'BE', shares: 100, cost: 79.67, categories: ['AI硬件'] },
    { ticker: 'AVGO', shares: 30, cost: 346.17, categories: ['AI硬件'] },
    { ticker: 'BABA', shares: 130, cost: 166.17, categories: ['做多中国'] },
    { ticker: 'VRT', shares: 80, cost: 136.83, categories: ['AI硬件'] },
    { ticker: 'YINN', shares: 100, cost: 20.00, categories: ['做多中国'] },
    { ticker: 'PLTR', shares: 100, cost: 25.00, categories: ['AI软件'] },
    { ticker: 'PAAS', shares: 50, cost: 15.00, categories: ['宏观对冲'] },
    { ticker: 'EZJ', shares: 50, cost: 5.00, categories: ['宏观对冲'] },
    { ticker: 'TSM', shares: 100, cost: 150.00, categories: ['AI硬件'] },
    { ticker: 'META', shares: 50, cost: 450.00, categories: ['AI软件'] }
];


let portfolioData = JSON.parse(JSON.stringify(initialPortfolio));
let chartInstances = {};
const apiKey = 'LBE3O9F31CBTSKQE'; 
const CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存
window.latestTradingDay = ''; // 用于存储最新交易日

// --- 2. 核心逻辑：数据获取与计算 ---

async function fetchAllPricesAndUpdate() {
    if (!apiKey || apiKey === '在此处粘贴您的ALPHA_VANTAGE_API密钥') {
        const statusEl = document.getElementById('update-status');
        statusEl.textContent = '错误: 请在代码中设置有效的 Alpha Vantage API 密钥。';
        statusEl.className = 'mb-2 text-red-500';
        return false;
    }

    const tickers = portfolioData.map(stock => stock.ticker);
    const statusEl = document.getElementById('update-status');

    for (let i = 0; i < tickers.length; i++) {
        const ticker = tickers[i];
        statusEl.textContent = `正在获取 (${i + 1}/${tickers.length}): ${ticker}...`;
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${apiKey}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API 请求失败，状态码: ${response.status}`);
            
            const data = await response.json();

            if (data["Note"]) {
                const detailedError = "已达到API的免费调用频率(每分钟5次)或每日总量限制。请稍后再试。";
                throw new Error(detailedError);
            }
            
            const quote = data["Global Quote"];
            if (!quote || Object.keys(quote).length === 0) {
                 throw new Error(`未能找到 ${ticker} 的报价数据。`);
            }

            const priceStr = quote["05. price"];
            const prevCloseStr = quote["08. previous close"];
            const latestDay = quote["07. latest trading day"];
            
            if (i === 0 && latestDay) { // 仅在获取第一个股票时设置全局日期
                window.latestTradingDay = latestDay; 
            }

            const stockToUpdate = portfolioData.find(s => s.ticker === ticker);

            if (stockToUpdate && priceStr && prevCloseStr) {
                stockToUpdate.currentPrice = parseFloat(priceStr);
                stockToUpdate.previousClose = parseFloat(prevCloseStr); // 保存昨日收盘价
                const metrics = calculateAllMetrics();
                renderDashboard(metrics);
            } else {
                 throw new Error(`未能从API响应中完整解析 ${ticker} 的价格数据。`);
            }

            if (i < tickers.length - 1) {
                // [已修改] 增加API调用间隔以提高稳定性
                await new Promise(resolve => setTimeout(resolve, 16000)); 
            }

        } catch (error) {
            console.error(`获取 ${ticker} 股价失败:`, error);
            let detailedError = error.message;
            if (error.message.includes('未能找到')) {
                detailedError += ' (这通常是由于达到了免费API的每日调用上限)';
            }
            statusEl.textContent = `错误: ${detailedError}`;
            statusEl.className = 'mb-2 text-red-500';
            return false;
        }
    }
    return true;
}


function calculateAllMetrics() {
    let totalMarketValue = 0, totalCost = 0, totalProfitLoss = 0, totalSingleDayPl = 0;
    const categoryDistribution = {};

    portfolioData.forEach(stock => {
        stock.costValue = stock.shares * stock.cost;
        totalCost += stock.costValue;

        if (stock.currentPrice && typeof stock.currentPrice === 'number') {
            stock.marketValue = stock.shares * stock.currentPrice;
            stock.profitLoss = stock.marketValue - stock.costValue;
            stock.profitLossPercent = stock.costValue === 0 ? 0 : (stock.profitLoss / stock.costValue) * 100;
            
            if (stock.previousClose && typeof stock.previousClose === 'number') {
                stock.singleDayPl = (stock.currentPrice - stock.previousClose) * stock.shares;
                totalSingleDayPl += stock.singleDayPl;
            } else {
                stock.singleDayPl = 0;
            }
        } else {
            stock.marketValue = stock.costValue;
            stock.profitLoss = 0;
            stock.profitLossPercent = 0;
            stock.singleDayPl = 0;
        }

        totalMarketValue += stock.marketValue;
        totalProfitLoss += stock.profitLoss;

        stock.categories.forEach(cat => {
            categoryDistribution[cat] = (categoryDistribution[cat] || 0) + stock.marketValue;
        });
    });

    return { totalMarketValue, totalCost, totalProfitLoss, categoryDistribution, totalSingleDayPl };
}

// --- 3. UI 渲染模块 ---

function renderDashboard(metrics) {
    renderSummary(metrics);
    renderTable();
    updateCharts(metrics);
}

function renderSummary({ totalMarketValue, totalCost, totalProfitLoss, totalSingleDayPl }) {
    const summaryContainer = document.getElementById('summary');
    const totalPlClass = totalProfitLoss >= 0 ? 'positive-value' : 'negative-value';
    const singleDayPlClass = totalSingleDayPl >= 0 ? 'positive-value' : 'negative-value';
    
    summaryContainer.innerHTML = `
        <div class="card text-center">
            <h3 class="text-lg font-semibold text-gray-400">总市值</h3>
            <p class="text-3xl font-bold text-white mt-2">${totalMarketValue.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
        </div>
        <div class="card text-center">
            <h3 class="text-lg font-semibold text-gray-400">总成本</h3>
            <p class="text-3xl font-bold text-white mt-2">${totalCost.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
        </div>
        <div class="card text-center">
            <h3 class="text-lg font-semibold text-gray-400">单日总盈亏</h3>
            <p class="text-3xl font-bold mt-2 ${singleDayPlClass}">${totalSingleDayPl.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
        </div>
        <div class="card text-center">
            <h3 class="text-lg font-semibold text-gray-400">累计总盈亏</h3>
            <p class="text-3xl font-bold mt-2 ${totalPlClass}">${totalProfitLoss.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
        </div>
    `;
}

function renderTable() {
    const tableBody = document.getElementById('portfolio-table-body');
    tableBody.innerHTML = '';
    portfolioData.forEach(stock => {
        const row = document.createElement('tr');
        row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors duration-200';
        
        let currentPriceHTML;
        if (stock.currentPrice && typeof stock.currentPrice === 'number') {
             currentPriceHTML = stock.currentPrice.toFixed(2);
        } else {
            currentPriceHTML = `<div class="loader h-4 w-4 ml-auto mr-auto"></div>`;
        }

        let singleDayPlHTML;
        if (stock.currentPrice) {
            const singleDayPlClass = stock.singleDayPl >= 0 ? 'positive-value' : 'negative-value';
            singleDayPlHTML = `<span class="${singleDayPlClass}">${stock.singleDayPl.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>`;
        } else {
            singleDayPlHTML = '';
        }

        const totalPlClass = stock.profitLoss >= 0 ? 'positive-value' : 'negative-value';

        row.innerHTML = `
            <td class="p-3 font-semibold text-white">${stock.ticker}</td>
            <td class="p-3 text-right">${stock.shares}</td>
            <td class="p-3 text-right">
                <input type="number" value="${stock.cost.toFixed(2)}" 
                       onchange="handleCostChange(event, '${stock.ticker}')"
                       class="input-field w-28 text-right p-1" step="0.01" />
            </td>
            <td class="p-3 text-right font-mono">${currentPriceHTML}</td>
            <td class="p-3 text-right font-mono">${stock.marketValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td class="p-3 text-right font-mono">${singleDayPlHTML}</td>
            <td class="p-3 text-right font-mono ${totalPlClass}">${stock.profitLoss.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td class="p-3 text-right font-mono ${totalPlClass}">${stock.profitLossPercent.toFixed(2)}%</td>
        `;
        tableBody.appendChild(row);
    });
}

function destroyAllCharts() {
    Object.values(chartInstances).forEach(chart => chart && chart.destroy());
    chartInstances = {};
}

function updateCharts({ categoryDistribution, totalMarketValue }) {
    destroyAllCharts();

    const getTooltipCallback = (chartType) => {
        return {
            callbacks: {
                label: function(context) {
                    let label = context.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed !== null) {
                        const value = context.parsed;
                        const currencyValue = value.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
                        
                        const totalForPercentage = chartType === 'pie' ? Object.values(context.chart.data.datasets[0].data).reduce((a, b) => a + b, 0) : 0;

                        if (chartType === 'pie' && totalForPercentage > 0) {
                            const percentage = ((value / totalForPercentage) * 100).toFixed(2);
                            label += `${currencyValue} (${percentage}%)`;
                        } else {
                             label += currencyValue;
                        }
                    }
                    return label;
                }
            }
        };
    };

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { labels: { color: '#e0e0e0' } }
        }
    };
    
    const chartColors = ['#4f46e5', '#7c3aed', '#10b981', '#f97316', '#ec4899', '#f59e0b', '#6366f1', '#14b8a6', '#d946ef', '#0ea5e9', '#84cc16', '#22d3ee', '#a78bfa'];

    // 持仓分布饼图
    chartInstances.portfolioPie = new Chart(document.getElementById('portfolioPieChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: portfolioData.map(s => s.ticker),
            datasets: [{ data: portfolioData.map(s => s.marketValue), backgroundColor: chartColors, borderColor: '#1e1b33', hoverOffset: 4 }]
        },
        options: { ...commonOptions, plugins: { ...commonOptions.plugins, legend: { position: 'right' }, tooltip: getTooltipCallback('pie') } }
    });
    
    // 策略分布饼图
    chartInstances.categoryPie = new Chart(document.getElementById('categoryPieChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryDistribution),
            datasets: [{ data: Object.values(categoryDistribution), backgroundColor: chartColors.slice().reverse(), borderColor: '#1e1b33', hoverOffset: 4 }]
        },
        options: { ...commonOptions, plugins: { ...commonOptions.plugins, legend: { position: 'right' }, tooltip: getTooltipCallback('pie') } }
    });

    // 盈亏条形图
    const profitData = portfolioData.filter(s => s.currentPrice);
    chartInstances.profitLossBar = new Chart(document.getElementById('profitLossBarChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: profitData.map(s => s.ticker),
            datasets: [{ label: '个股总盈亏 ($)', data: profitData.map(s => s.profitLoss), backgroundColor: profitData.map(s => s.profitLoss >= 0 ? 'rgba(74, 222, 128, 0.6)' : 'rgba(248, 113, 113, 0.6)'), borderColor: profitData.map(s => s.profitLoss >= 0 ? '#4ade80' : '#f87171'), borderWidth: 1 }]
        },
        options: { ...commonOptions, indexAxis: 'y', scales: { y: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { ...commonOptions.plugins, legend: { display: false }, tooltip: getTooltipCallback('bar') } }
    });
}

// --- 4. 事件处理 & 初始化 ---
function toggleButtonLoading(isLoading) {
    const btn = document.getElementById('refreshBtn');
    const btnText = document.getElementById('btn-text');
    const btnLoader = document.getElementById('btn-loader');
    if (isLoading) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
    } else {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoader.classList.add('hidden');
    }
}

async function fullReload() {
    toggleButtonLoading(true);
    portfolioData.forEach(stock => {
        delete stock.currentPrice;
        delete stock.previousClose;
    });
    renderDashboard(calculateAllMetrics()); 

    const success = await fetchAllPricesAndUpdate();
    if (success) {
        localStorage.setItem('portfolioCache', JSON.stringify({ portfolio: portfolioData, timestamp: Date.now() }));
        const metrics = calculateAllMetrics(); 
        renderDashboard(metrics);
        
        const statusEl = document.getElementById('update-status');
        let statusText = `数据更新完毕。单日盈亏基于 ${window.latestTradingDay} 收盘价计算。`;
        statusEl.textContent = statusText;
        statusEl.className = 'mb-2 text-green-400';
    }
    toggleButtonLoading(false);
}

window.handleCostChange = (event, ticker) => {
    const stock = portfolioData.find(s => s.ticker === ticker);
    const newCost = parseFloat(event.target.value);
    
    if (stock && !isNaN(newCost) && newCost >= 0) {
        stock.cost = newCost;
        const metrics = calculateAllMetrics();
        renderDashboard(metrics);
        const cached = JSON.parse(localStorage.getItem('portfolioCache'));
        if (cached) {
            const cachedStock = cached.portfolio.find(s => s.ticker === ticker);
            if (cachedStock) cachedStock.cost = newCost;
            localStorage.setItem('portfolioCache', JSON.stringify(cached));
        }
    } else {
        event.target.value = stock.cost.toFixed(2);
    }
};

function loadInitialData() {
    const statusEl = document.getElementById('update-status');
    try {
        const cachedData = JSON.parse(localStorage.getItem('portfolioCache'));
        if (cachedData && (Date.now() - cachedData.timestamp < CACHE_DURATION)) {
            portfolioData = cachedData.portfolio;
        }
    } catch(e) { console.error("无法加载缓存:", e); }
    
    const metrics = calculateAllMetrics();
    renderDashboard(metrics);
    statusEl.textContent = '请点击上方按钮，加载实时市场数据。';
    statusEl.className = 'mb-2 text-yellow-400';
}

document.getElementById('refreshBtn').addEventListener('click', fullReload);
document.addEventListener('DOMContentLoaded', loadInitialData);

</script>
</body>
</html>

